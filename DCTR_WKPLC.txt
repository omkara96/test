--DCTR WKPLC

INSERT INTO CIM_LC_INT.PRC_ULT_DCTR_WKPLC
(T.LYT_CLS, T.RCR_ID, T.PRS_CD, T.PRS_CD_RSV, T.MDF_CLS, T.WKP_FCL_RCR_ID, T.WKP_FCL_CD, T.WKP_FCL_CD_RSV, T.RSV_RTR_MV_CLS, T.MNT_DT, T.RSV_TRN_DT_VN, T.PST_CD, T.UNV_PST_CD, T.DPR_CD, T.DPR_KNJ, T.DPR_KN, T.N_DRC_ML_FLG, T.SRC_LOAD_BATCH_ID, T.CRTN_ID, T.SYS_CRTN_DT_TM, T.LAST_UPDT_ID, T.SYS_LAST_UPDT_DT_TM, T.MDM_DMN_GEO_CD, T.INFO_SRC_CD, T.INFO_SRC_OBJ_NM, T.LOAD_KEY, T.OPERATION_FLAG, T.DA_SOURCE_CODE, T.DA_AREA_CODE)
SELECT S.LYT_CLS, S.RCR_ID, S.PRS_CD, S.PRS_CD_RSV, S.MDF_CLS, S.WKP_FCL_RCR_ID, S.WKP_FCL_CD, S.WKP_FCL_CD_RSV, '1', S.PARENT_MNT_DT, S.RSV_TRN_DT_VN, S.PST_CD, S.UNV_PST_CD, S.DPR_CD, S.DPR_KNJ, S.DPR_KN, S.N_DRC_ML_FLG, S.SRC_LOAD_BATCH_ID, S.CRTN_ID, S.SYS_CRTN_DT_TM, S.LAST_UPDT_ID, S.SYS_LAST_UPDT_DT_TM, S.MDM_DMN_GEO_CD, S.INFO_SRC_CD, S.INFO_SRC_OBJ_NM, S.LOAD_KEY, 'D', S.DA_SOURCE_CODE, S.DA_AREA_CODE
FROM (
    SELECT C.*, P.MNT_DT AS PARENT_MNT_DT, P.LOAD_KEY
    FROM CIM_LC_INT.PRC_ULT_DCTR P
    JOIN CIM_LC_PRST.PRST_ULT_DCTR_WKPLC_C C
    ON C.PRS_CD = P.PRS_CD
        AND C.DA_AREA_CODE = P.DA_AREA_CODE
        AND C.DA_SOURCE_CODE = P.DA_SOURCE_CODE
    WHERE P.MDF_CLS = 'C'
        AND P.DA_AREA_CODE = 'pi_str_areaCode'
        AND P.DA_SOURCE_CODE = 'pi_str_sourceCode'
) S
LEFT JOIN CIM_LC_INT.PRC_ULT_DCTR_WKPLC T
    ON S.PRS_CD = T.PRS_CD
        AND S.WKP_FCL_CD = T.WKP_FCL_CD
        AND S.DA_AREA_CODE = T.DA_AREA_CODE
        AND S.DA_SOURCE_CODE = T.DA_SOURCE_CODE
WHERE T.PRS_CD IS NULL;


UPDATE CIM_LC_INT.PRC_ULT_DCTR_WKPLC
SET RSV_RTR_MV_CLS = '1',
    OPERATION_FLAG = 'D',
    MNT_DT = S.PARENT_MNT_DT
FROM (
    SELECT C.*, P.MNT_DT AS PARENT_MNT_DT, P.LOAD_KEY
    FROM CIM_LC_INT.PRC_ULT_DCTR P
    JOIN CIM_LC_PRST.PRST_ULT_DCTR_WKPLC_C C
    ON C.PRS_CD = P.PRS_CD
        AND C.DA_AREA_CODE = P.DA_AREA_CODE
        AND C.DA_SOURCE_CODE = P.DA_SOURCE_CODE
    WHERE P.MDF_CLS = 'C'
        AND P.DA_AREA_CODE = 'pi_str_areaCode'
        AND P.DA_SOURCE_CODE = 'pi_str_sourceCode'
) S
WHERE CIM_LC_INT.PRC_ULT_DCTR_WKPLC.PRS_CD = S.PRS_CD
    AND CIM_LC_INT.PRC_ULT_DCTR_WKPLC.WKP_FCL_CD = S.WKP_FCL_CD
    AND CIM_LC_INT.PRC_ULT_DCTR_WKPLC.DA_AREA_CODE = S.DA_AREA_CODE
    AND CIM_LC_INT.PRC_ULT_DCTR_WKPLC.DA_SOURCE_CODE = S.DA_SOURCE_CODE
    AND NVL(CIM_LC_INT.PRC_ULT_DCTR_WKPLC.RSV_RTR_MV_CLS, 'X') <> '1';
